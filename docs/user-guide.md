# Руководство администратора CRM

## Оглавление

1. [Введение](#1-введение)
2. [Ключевые концепции](#2-ключевые-концепции)
3. [Управление метаданными](#3-управление-метаданными)
   - [Объекты](#31-объекты)
   - [Поля](#32-поля)
4. [Управление безопасностью](#4-управление-безопасностью)
   - [Роли](#41-роли)
   - [Наборы разрешений](#42-наборы-разрешений)
   - [Профили](#43-профили)
   - [Пользователи](#44-пользователи)
   - [Группы](#45-группы)
   - [Правила совместного доступа](#46-правила-совместного-доступа)
   - [Ручной шаринг](#47-ручной-шаринг)
5. [Типичные сценарии](#5-типичные-сценарии)

---

## 1. Введение

### Назначение

Админ-панель CRM предназначена для системных администраторов и позволяет:

- Управлять **метаданными** — определять объекты и их поля (схему данных), настраивать видимость объектов (OWD).
- Управлять **безопасностью** — настраивать роли, профили, наборы разрешений, пользователей, группы, правила совместного доступа и ручной шаринг записей.

### Для кого

Документ предназначен для системного администратора, ответственного за конфигурацию CRM-платформы: создание структуры данных, настройку прав доступа и управление пользователями.

### Навигация

Админ-панель доступна по адресу `/admin`. Интерфейс состоит из двух частей:

- **Боковая панель** (слева, ширина 240px) — навигация по разделам.
- **Основная область** (справа) — содержимое выбранного раздела.

Структура боковой панели:

| Пункт | Маршрут |
|-------|---------|
| **Объекты** | `/admin/metadata/objects` |
| **Безопасность** (группа, раскрывается) | |
| — Роли | `/admin/security/roles` |
| — Наборы разрешений | `/admin/security/permission-sets` |
| — Профили | `/admin/security/profiles` |
| **Пользователи** | `/admin/security/users` |

Группа «Безопасность» раскрывается автоматически при переходе к любому из её подразделов.

Все страницы деталей содержат **хлебные крошки** (breadcrumbs) для удобной навигации назад.

### Общие элементы интерфейса

- **Таблицы** с постраничной навигацией (20 записей на страницу). Кнопки «Назад» / «Вперёд» появляются при наличии нескольких страниц.
- **Меню действий** (три вертикальные точки) в каждой строке таблицы — содержит пункты «Открыть» и «Удалить».
- **Диалог подтверждения удаления** — перед удалением любой сущности система запрашивает подтверждение.
- **Toast-уведомления** — сообщения об успешных операциях и ошибках.

---

## 2. Ключевые концепции

### Модель безопасности

Система безопасности CRM реализует три слоя контроля доступа:

1. **OLS (Object-Level Security)** — права на уровне объекта. Определяет, какие CRUD-операции разрешены для данного объекта.
2. **FLS (Field-Level Security)** — права на уровне поля. Определяет, какие поля пользователь может читать и/или редактировать.
3. **RLS (Row-Level Security)** — права на уровне записи. Определяет, какие конкретно записи видит пользователь на основе OWD-видимости объекта, иерархии ролей, групп, правил совместного доступа и ручного шаринга.

### Иерархия сущностей безопасности

```
Профиль (Profile)
  └── Базовый набор разрешений (base Permission Set, тип grant)
        ├── OLS: права на объекты
        └── FLS: права на поля

Пользователь (User)
  ├── Профиль (ровно один, обязательный)
  ├── Роль (опциональная, используется для RLS)
  ├── Дополнительные наборы разрешений (grant и/или deny)
  └── Группы (автоматические и ручные)

Группы (Groups)
  ├── Personal — одна на пользователя (авто-создание)
  ├── Role — одна на роль (авто-создание)
  ├── Role & Subordinates — одна на роль (авто-создание)
  └── Public — создаются администратором

Правила совместного доступа (Sharing Rules)
  ├── Owner-based — на основе владельца записи
  └── Criteria-based — на основе значения поля записи
```

### OWD (Organization-Wide Defaults) — видимость объекта

Видимость (OWD) определяет **базовый уровень доступа** ко всем записям объекта для всех пользователей. Это отправная точка RLS — далее доступ расширяется через иерархию ролей, группы и правила шаринга.

| Видимость | Описание |
|-----------|----------|
| `private` | Пользователь видит только свои записи (по полю `owner_id`). Доступ расширяется через иерархию ролей, группы и шаринг. |
| `public_read` | Все пользователи могут читать все записи. Обновление — только владелец, иерархия или шаринг. |
| `public_read_write` | Полный доступ для всех. RLS-фильтрация отключена. Share-таблица не создаётся. |
| `controlled_by_parent` | Доступ определяется родительским объектом (для композиционных связей). |

Видимость задаётся при создании объекта и может быть изменена позднее. При смене видимости система автоматически создаёт или удаляет share-таблицу.

### Группы

Группы — это механизм объединения пользователей для целей шаринга. Все операции шаринга (ручной, через правила) выполняются через группы.

| Тип группы | Описание | Создание |
|------------|----------|----------|
| `personal` | Содержит одного пользователя | Автоматически при создании пользователя |
| `role` | Содержит всех пользователей с данной ролью | Автоматически при создании роли |
| `role_and_subordinates` | Содержит пользователей с данной ролью и всех подчинённых ролей | Автоматически при создании роли |
| `public` | Произвольная группа пользователей | Вручную администратором |

При изменении роли пользователя его членство в ролевых группах пересчитывается автоматически.

### Принцип вычисления эффективных прав

```
effective = grants & ~denies
```

1. Базовые права определяются **профилем** пользователя (через его базовый набор разрешений).
2. Дополнительные **grant-наборы** расширяют права (битовое ИЛИ).
3. **Deny-наборы** глобально подавляют указанные права (битовое И с инверсией).

Deny всегда побеждает Grant.

### Bitmask-модель прав

**OLS (права на объект):**

| Бит | Значение | Операция |
|-----|----------|----------|
| 1   | `0001`   | Чтение   |
| 2   | `0010`   | Создание |
| 4   | `0100`   | Обновление |
| 8   | `1000`   | Удаление |

Полный доступ = `15` (все 4 бита установлены).

**FLS (права на поле):**

| Бит | Значение | Операция |
|-----|----------|----------|
| 1   | `01`     | Чтение   |
| 2   | `10`     | Запись   |

Полный доступ = `3` (оба бита установлены).

### Роли

Роли образуют **иерархию** (дерево). Они используются для Row-Level Security:

- Пользователь с более высокой ролью в иерархии может видеть записи подчинённых (только чтение).
- У пользователя может быть ровно одна роль (или ни одной).

---

## 3. Управление метаданными

### 3.1. Объекты

Объект — это описание сущности в системе (аналог таблицы). Каждый объект хранит метаданные: имя, тип, флаги поведения.

#### Список объектов

**Маршрут:** `/admin/metadata/objects`

Страница отображает таблицу со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор объекта (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Тип | `standard` или `custom` (отображается бейджем) |
| Создан | Дата создания |

**Фильтрация:** выпадающий список для фильтрации по типу объекта:
- Все типы
- Standard
- Custom

**Действия:**
- Кнопка **«Создать объект»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить» (удаление доступно только если `isDeleteableObject = true` и `isPlatformManaged = false`).

#### Создание объекта

**Маршрут:** `/admin/metadata/objects/new`

Форма состоит из двух карточек:

**Карточка «Основная информация»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя объекта (например, `Invoice__c`). Задаётся при создании, далее не редактируется. |
| Название | Текст | Да | Отображаемое имя в единственном числе (например, «Счёт») |
| Мн. число | Текст | Да | Название во множественном числе (например, «Счета») |
| Тип объекта | Выбор | Да | `standard` или `custom`. Задаётся при создании, далее не редактируется. |
| Видимость (OWD) | Выбор | Нет | Базовый уровень доступа к записям: `private` (по умолчанию), `public_read`, `public_read_write`, `controlled_by_parent`. См. [OWD](#owd-organization-wide-defaults--видимость-объекта). |
| Описание | Многострочный текст | Нет | Произвольное описание объекта |

**Карточка флагов** (три группы чекбоксов):

**Группа «Разрешения на записи»:**

| Флаг | Описание |
|------|----------|
| `isCreateable` | Разрешено создание записей этого объекта |
| `isUpdateable` | Разрешено обновление записей |
| `isDeleteable` | Разрешено удаление записей |
| `isQueryable` | Объект доступен для запросов через SOQL |
| `isSearchable` | Объект доступен для полнотекстового поиска |

**Группа «Настройки объекта»:**

| Флаг | Описание |
|------|----------|
| `isVisibleInSetup` | Объект отображается в интерфейсе настроек |
| `isCustomFieldsAllowed` | К объекту можно добавлять пользовательские поля |
| `isDeleteableObject` | Сам объект можно удалить |

**Группа «Возможности»:**

| Флаг | Описание |
|------|----------|
| `hasActivities` | Поддержка активностей (задачи, события) |
| `hasNotes` | Поддержка заметок |
| `hasHistoryTracking` | Ведение истории изменений |
| `hasSharingRules` | Поддержка правил общего доступа (RLS) |

После нажатия **«Создать»** происходит переход на детальную страницу созданного объекта.

#### Редактирование объекта

**Маршрут:** `/admin/metadata/objects/:objectId`

Детальная страница содержит две вкладки:

**Вкладка «Основное»:**
- Все те же поля, что при создании, но **API Name** и **Тип объекта** — только для чтения (disabled).
- Название, Мн. число, Описание, **Видимость (OWD)** и все флаги — редактируемые.
- При изменении видимости с/на `public_read_write` система автоматически создаёт или удаляет share-таблицу объекта.
- Кнопка **«Сохранить»** — сохраняет изменения.

**Вкладка «Поля (N)»:**
- Отображает таблицу полей объекта (см. [3.2. Поля](#32-поля)).
- В заголовке вкладки показано количество полей.

**Удаление объекта:**
- Кнопка **«Удалить объект»** (красная, в правом верхнем углу) видна только если `isDeleteableObject = true` и `isPlatformManaged = false`.
- Удаление требует подтверждения. Текст предупреждения: *«Объект «{label}» ({apiName}) и все его поля будут удалены без возможности восстановления»*.

### 3.2. Поля

Поле — это атрибут объекта (аналог колонки таблицы). Каждое поле имеет тип, подтип и дополнительную конфигурацию.

#### Таблица полей

Таблица полей отображается на вкладке «Поля» детальной страницы объекта. Для каждого поля отображаются: API Name, Название, Тип, Подтип, флаги «Обязательное» и «Уникальное».

Действия:
- Кнопка **«Добавить поле»** — открывает диалог создания.
- Кнопка **«Редактировать»** — открывает диалог редактирования.
- Кнопка **«Удалить»** — удаляет поле (с подтверждением).

#### Типы и подтипы полей

| Тип | Русское название | Доступные подтипы |
|-----|-----------------|-------------------|
| `text` | Текст | `plain` (Простой текст), `area` (Многострочный), `rich` (Форматированный), `email` (Email), `phone` (Телефон), `url` (URL) |
| `number` | Число | `integer` (Целое), `decimal` (Десятичное), `currency` (Валюта), `percent` (Процент), `auto_number` (Авто-номер) |
| `boolean` | Логический | — (без подтипов) |
| `datetime` | Дата/Время | `date` (Дата), `datetime` (Дата и время), `time` (Время) |
| `picklist` | Список выбора | `single` (Одиночный), `multi` (Множественный) |
| `reference` | Связь | `association` (Ассоциация), `composition` (Композиция), `polymorphic` (Полиморфная) |

#### Создание поля

Диалог создания поля содержит следующие поля:

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя поля в рамках объекта |
| Название | Текст | Да | Отображаемое имя поля |
| Тип | Выбор | Да | Один из шести типов: text, number, boolean, datetime, picklist, reference |
| Подтип | Выбор | Зависит от типа | Список доступных подтипов зависит от выбранного типа. Для boolean подтипы отсутствуют. |
| Ссылочный объект | Выбор | Для reference | Объект, на который ссылается поле |
| Описание | Текст | Нет | Описание поля |
| Help Text | Текст | Нет | Текст-подсказка для пользователей |
| Обязательное | Чекбокс | Нет | Делает поле обязательным для заполнения |
| Уникальное | Чекбокс | Нет | Значение поля должно быть уникальным |
| Пользовательское | Чекбокс | Нет | Отмечает поле как custom |
| Порядок сортировки | Число | Нет | Порядок отображения поля |

#### Конфигурация поля по типу/подтипу

В зависимости от выбранной комбинации тип/подтип доступны дополнительные поля конфигурации:

**Текстовые поля (text/plain, text/area, text/rich):**

| Параметр | Описание |
|----------|----------|
| Макс. длина | Максимальная длина текста |
| Значение по умолчанию | Значение, подставляемое при создании записи |

**Текстовые (email, phone, url):**

| Параметр | Описание |
|----------|----------|
| Макс. длина | Максимальная длина текста |

**Целое число (number/integer):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | Значение по умолчанию |

**Десятичное / Валюта / Процент (number/decimal, number/currency, number/percent):**

| Параметр | Описание |
|----------|----------|
| Точность (всего цифр) | Общее количество значащих цифр |
| Масштаб (после запятой) | Количество знаков после десятичной точки |
| Значение по умолчанию | Значение по умолчанию |

**Авто-номер (number/auto_number):**

| Параметр | Описание |
|----------|----------|
| Формат | Шаблон нумерации, например `INV-{0000}` |
| Начальное значение | Стартовое значение счётчика |

**Логический (boolean):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | `true` или `false` |

**Дата/Время (datetime/date, datetime/datetime, datetime/time):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | Значение по умолчанию |

**Ассоциация (reference/association):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `set_null` (Очистить) или `restrict` (Запретить) |

**Композиция (reference/composition):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `cascade` (Каскадное удаление) или `restrict` (Запретить) |
| Можно переназначить родителя | Разрешена ли смена родительского объекта |

**Полиморфная связь (reference/polymorphic):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `set_null` (Очистить) или `restrict` (Запретить) |

#### Редактирование поля

Диалог редактирования позволяет изменить:
- Название
- Описание
- Help Text
- Обязательное (чекбокс)
- Уникальное (чекбокс)
- Параметры конфигурации (зависят от типа/подтипа)
- Порядок сортировки

**API Name**, **Тип** и **Подтип** — не редактируются после создания.

#### Удаление поля

Удаление поля выполняется через кнопку «Удалить» в таблице полей. Операция необратима.

---

## 4. Управление безопасностью

### 4.1. Роли

Роли определяют положение пользователя в организационной иерархии. Используются для Row-Level Security: пользователи с более высокой ролью получают доступ на чтение записей подчинённых.

#### Список ролей

**Маршрут:** `/admin/security/roles`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор роли (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Родительская роль | Название роли-родителя или «—» для корневых ролей |
| Создан | Дата создания |

Действия:
- Кнопка **«Создать роль»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание роли

**Маршрут:** `/admin/security/roles/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя роли (например, `sales_manager`). Задаётся при создании, далее не редактируется. |
| Название | Текст | Да | Отображаемое имя (например, «Менеджер по продажам») |
| Родительская роль | Выбор | Нет | Выбор из списка существующих ролей. Вариант «Без родителя» — корневая роль. |
| Описание | Многострочный текст | Нет | Произвольное описание роли |

После создания происходит переход на детальную страницу роли.

> **Автоматические группы:** При создании роли система автоматически создаёт две группы: `role_{api_name}` (все пользователи с данной ролью) и `role_and_sub_{api_name}` (пользователи с данной ролью и подчинёнными ролями).

#### Редактирование роли

**Маршрут:** `/admin/security/roles/:roleId`

- **API Name** — только для чтения.
- **Название**, **Родительская роль**, **Описание** — редактируемые.
- В списке родительских ролей исключена текущая роль (нельзя назначить роль родителем самой себя).
- Кнопка **«Сохранить»** — сохраняет изменения.

#### Удаление роли

Кнопка **«Удалить роль»** (красная) в правом верхнем углу детальной страницы. Требует подтверждения.

### 4.2. Наборы разрешений

Набор разрешений (Permission Set) — это контейнер для OLS- и FLS-прав. Бывает двух типов:

- **Grant** — расширяет права (разрешает операции).
- **Deny** — глобально подавляет права (запрещает операции, даже если они разрешены в других наборах).

#### Список наборов разрешений

**Маршрут:** `/admin/security/permission-sets`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Тип | `Grant` или `Deny` (отображается бейджем) |
| Создан | Дата создания |

**Фильтрация:** выпадающий список для фильтрации по типу:
- Все типы
- Grant
- Deny

Действия:
- Кнопка **«Создать набор»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание набора разрешений

**Маршрут:** `/admin/security/permission-sets/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя (например, `sales_read_access`). Не редактируется после создания. |
| Название | Текст | Да | Отображаемое имя (например, «Доступ на чтение продаж») |
| Тип | Выбор | Да | `Grant (разрешает)` или `Deny (запрещает)`. Не редактируется после создания. |
| Описание | Многострочный текст | Нет | Произвольное описание |

#### Детальная страница набора разрешений

**Маршрут:** `/admin/security/permission-sets/:permissionSetId`

Содержит три вкладки:

**Вкладка «Основное»:**
- API Name (только чтение), Название, Тип (только чтение), Описание.
- Кнопка «Сохранить» для сохранения изменений названия и описания.

**Вкладка «Права на объекты» (OLS):**

Таблица, где каждая строка — это объект из метаданных. Для каждого объекта отображается группа чекбоксов:

| Чекбокс | Бит | Описание |
|---------|-----|----------|
| Чтение | 1 | Право на чтение записей объекта |
| Создание | 2 | Право на создание записей |
| Обновление | 4 | Право на обновление записей |
| Удаление | 8 | Право на удаление записей |

Изменения сохраняются **мгновенно** при переключении чекбокса (без нажатия кнопки «Сохранить»).

**Вкладка «Права на поля» (FLS):**

1. Сначала нужно выбрать объект из выпадающего списка.
2. После выбора отображается таблица полей этого объекта. Для каждого поля — группа чекбоксов:

| Чекбокс | Бит | Описание |
|---------|-----|----------|
| Чтение | 1 | Право на чтение значения поля |
| Запись | 2 | Право на изменение значения поля |

Изменения также сохраняются **мгновенно**.

#### Удаление набора разрешений

Кнопка **«Удалить набор»** (красная) в правом верхнем углу. Требует подтверждения.

### 4.3. Профили

Профиль — это обязательная сущность безопасности, назначаемая каждому пользователю. При создании профиля автоматически создаётся **базовый набор разрешений** (grant-тип), который определяет начальные права пользователя.

#### Список профилей

**Маршрут:** `/admin/security/profiles`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Создан | Дата создания |

Действия:
- Кнопка **«Создать профиль»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание профиля

**Маршрут:** `/admin/security/profiles/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя (например, `sales_profile`). Не редактируется после создания. |
| Название | Текст | Да | Отображаемое имя (например, «Профиль менеджера») |
| Описание | Многострочный текст | Нет | Произвольное описание |

При создании профиля система автоматически генерирует базовый набор разрешений (grant).

#### Редактирование профиля

**Маршрут:** `/admin/security/profiles/:profileId`

- API Name (только чтение), Название, Описание — редактируемые.
- Ссылка **«Открыть базовый набор разрешений»** — переход на страницу редактирования базового набора разрешений профиля, где настраиваются OLS и FLS.
- Кнопка **«Сохранить»** — сохраняет изменения названия и описания.

> **Важно:** Для настройки OLS/FLS профиля необходимо перейти к его базовому набору разрешений через ссылку на детальной странице профиля.

#### Удаление профиля

Кнопка **«Удалить профиль»** (красная) в правом верхнем углу. Требует подтверждения.

### 4.4. Пользователи

Пользователь — это учётная запись человека в системе. Каждому пользователю назначается профиль (обязательно) и опционально — роль и дополнительные наборы разрешений.

#### Список пользователей

**Маршрут:** `/admin/security/users`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| Username | Имя пользователя (ссылка на детальную страницу) |
| Email | Электронная почта |
| Имя | Полное имя (имя + фамилия) |
| Профиль | Название назначенного профиля |
| Роль | Название назначенной роли или «—» |
| Статус | Бейдж «Активен» / «Неактивен» |

Действия:
- Кнопка **«Создать пользователя»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание пользователя

**Маршрут:** `/admin/security/users/new`

Форма состоит из трёх карточек:

**Карточка «Учётные данные»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Имя пользователя | Текст | Да | Уникальное имя для входа (например, `john.doe`). Не редактируется после создания. |
| Email | Email | Да | Электронная почта |

**Карточка «Личные данные»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Имя | Текст | Нет | Имя пользователя |
| Фамилия | Текст | Нет | Фамилия пользователя |

**Карточка «Безопасность»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Профиль | Выбор | Да | Выбор из списка созданных профилей |
| Роль | Выбор | Нет | Выбор из списка ролей. Вариант «Без роли» — пользователь не входит в иерархию. |

> **Автоматические действия при создании:** Система автоматически создаёт персональную группу `personal_{username}` и добавляет пользователя в неё, а также в ролевые группы (если роль указана).

#### Редактирование пользователя

**Маршрут:** `/admin/security/users/:userId`

Содержит две вкладки:

**Вкладка «Основное»:**

- **Имя пользователя** — только для чтения.
- **Email**, **Имя**, **Фамилия** — редактируемые.
- **Профиль** и **Роль** — изменяемые через выпадающие списки. При смене роли членство в ролевых группах пересчитывается автоматически.
- **Активен** — переключатель (Switch). Неактивный пользователь не может войти в систему.
- Кнопка **«Сохранить»** — сохраняет изменения.

**Вкладка «Наборы разрешений»:**

Управление дополнительными наборами разрешений, назначенными пользователю.

Таблица назначенных наборов:

| Колонка | Описание |
|---------|----------|
| Название | Название набора разрешений |
| Тип | `Grant` или `Deny` (бейдж) |
| Назначен | Дата назначения |
| Действие | Кнопка «Отозвать» |

Действия:
- Кнопка **«Назначить набор»** — открывает диалог назначения. В диалоге доступен выпадающий список с наборами разрешений, которые ещё не назначены данному пользователю. Рядом с каждым набором показан его тип (grant/deny).
- Кнопка **«Отозвать»** — отзывает набор разрешений у пользователя (с подтверждением).

#### Удаление пользователя

Кнопка **«Удалить пользователя»** (красная) в правом верхнем углу. Требует подтверждения.

### 4.5. Группы

Группы объединяют пользователей для целей шаринга. Все записи шарятся именно группам, а не отдельным пользователям.

#### Автоматические группы

Три типа групп создаются автоматически и не управляются вручную:

- **Personal** — создаётся при создании пользователя. Содержит ровно одного пользователя. API Name: `personal_{username}`.
- **Role** — создаётся при создании роли. Содержит всех пользователей с данной ролью. API Name: `role_{api_name}`.
- **Role & Subordinates** — создаётся при создании роли. Содержит пользователей с данной ролью и со всех подчинённых ролей. API Name: `role_and_sub_{api_name}`.

Членство в этих группах пересчитывается автоматически при изменении роли пользователя или иерархии ролей.

#### Публичные группы

Публичные группы (`public`) создаются администратором вручную и позволяют объединять пользователей произвольным образом.

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя группы |
| Название | Текст | Да | Отображаемое имя |
| Тип | Выбор | Да | `personal`, `role`, `role_and_subordinates` или `public` |

#### Членство в группах

В группу можно добавить:
- **Пользователя** (по `member_user_id`).
- **Другую группу** (по `member_group_id`) — все члены вложенной группы становятся членами родительской.

> **Ограничение:** В одном добавлении указывается либо пользователь, либо группа — не оба одновременно.

Эффективное членство (с учётом вложенных групп) вычисляется автоматически и хранится в кэше `security.effective_group_members`.

### 4.6. Правила совместного доступа

Правила совместного доступа (Sharing Rules) расширяют видимость записей объекта для определённых групп пользователей. Правила работают аддитивно — они только добавляют доступ, но не могут его ограничить.

#### Типы правил

| Тип | Описание |
|-----|----------|
| `owner_based` | Записи, принадлежащие пользователям из **исходной группы**, становятся видны пользователям из **целевой группы**. |
| `criteria_based` | Записи, удовлетворяющие критерию (поле + оператор + значение), становятся видны пользователям из **целевой группы**. |

#### Создание правила

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Объект | UUID | Да | Объект, к которому применяется правило |
| Тип правила | Выбор | Да | `owner_based` или `criteria_based` |
| Исходная группа | UUID | Да | Группа владельцев записей (для owner_based) |
| Целевая группа | UUID | Да | Группа, которой предоставляется доступ |
| Уровень доступа | Выбор | Да | `read` — только чтение, `read_write` — чтение и запись |
| Поле критерия | Текст | Для criteria_based | Имя поля для фильтрации (например, `status`) |
| Оператор критерия | Текст | Для criteria_based | Оператор сравнения (например, `equals`) |
| Значение критерия | Текст | Для criteria_based | Значение для сравнения (например, `closed`) |

> **Примечание:** Генерация записей в share-таблицах на основе правил выполняется в Phase 3/4 (DML engine). Phase 2b хранит определения правил и генерирует outbox-события для пересчёта кэшей.

### 4.7. Ручной шаринг

Ручной шаринг позволяет предоставить доступ к конкретной записи определённой группе пользователей. Запись добавляется в share-таблицу объекта с причиной `manual`.

#### Предоставление доступа (Share)

| Параметр | Тип | Описание |
|----------|-----|----------|
| Таблица | Текст | Имя таблицы объекта (например, `obj_invoice`) |
| ID записи | UUID | Идентификатор записи, к которой предоставляется доступ |
| Группа | UUID | Идентификатор группы, которой предоставляется доступ |
| Уровень доступа | Выбор | `read` или `read_write` |

При повторном шаринге той же записи той же группе уровень доступа обновляется.

#### Отзыв доступа (Revoke)

Удаляет запись из share-таблицы с причиной `manual` для указанной пары (запись, группа).

#### Просмотр шарингов

Возвращает список всех записей из share-таблицы для конкретной записи (все причины: `manual`, `sharing_rule`, `territory`).

### Как RLS определяет видимость записи

Для объекта с видимостью `private` или `controlled_by_parent` пользователь видит запись, если выполняется хотя бы одно условие:

1. **Владелец** — пользователь является владельцем записи (`owner_id`).
2. **Иерархия ролей** — пользователь находится выше владельца в иерархии ролей (только чтение).
3. **Share-таблица** — запись расшарена группе, в которую входит пользователь (через ручной шаринг, правила или территории).

Для `public_read` — все могут читать; обновление — по тем же правилам, что `private`.
Для `public_read_write` — RLS-фильтрация полностью отключена.

---

## 5. Типичные сценарии

### Сценарий 1: Создать новый объект с полями

1. Перейдите в **Объекты** (`/admin/metadata/objects`).
2. Нажмите **«Создать объект»**.
3. Заполните:
   - API Name: `Invoice__c`
   - Название: `Счёт`
   - Мн. число: `Счета`
   - Тип объекта: `custom`
   - Включите нужные флаги (как минимум: Создание записей, Обновление записей, Запросы).
4. Нажмите **«Создать»**.
5. На детальной странице объекта перейдите на вкладку **«Поля»**.
6. Нажмите **«Добавить поле»** и создайте поля:
   - `number__c` — тип `text`, подтип `plain`, макс. длина: 50, обязательное, уникальное.
   - `amount__c` — тип `number`, подтип `currency`, точность: 18, масштаб: 2.
   - `invoice_date__c` — тип `datetime`, подтип `date`.
   - `account_id__c` — тип `reference`, подтип `association`, ссылочный объект: `Account`, при удалении: `set_null`.

### Сценарий 2: Настроить доступ к объекту

1. Создайте или откройте **набор разрешений** (`/admin/security/permission-sets`).
   - При создании: API Name: `invoice_access`, Название: «Доступ к счетам», Тип: `Grant`.
2. Перейдите на вкладку **«Права на объекты»**.
3. Найдите строку `Invoice__c` и отметьте нужные чекбоксы: Чтение, Создание, Обновление.
4. Перейдите на вкладку **«Права на поля»**.
5. Выберите объект `Invoice__c` в выпадающем списке.
6. Для каждого поля отметьте: Чтение и Запись.

### Сценарий 3: Создать пользователя с полным набором безопасности

1. **Создайте роль** (если ещё нет):
   - Перейдите в **Роли** → **«Создать роль»**.
   - API Name: `sales_manager`, Название: «Менеджер по продажам».
   - Родительская роль: выберите при необходимости.

2. **Создайте профиль** (если ещё нет):
   - Перейдите в **Профили** → **«Создать профиль»**.
   - API Name: `sales_profile`, Название: «Профиль продаж».

3. **Настройте OLS/FLS профиля:**
   - На детальной странице профиля нажмите ссылку **«Открыть базовый набор разрешений»**.
   - На вкладке **«Права на объекты»** — настройте CRUD-права.
   - На вкладке **«Права на поля»** — настройте доступ к полям.

4. **Создайте пользователя:**
   - Перейдите в **Пользователи** → **«Создать пользователя»**.
   - Заполните: username, email, имя, фамилия.
   - Выберите профиль: «Профиль продаж».
   - Выберите роль: «Менеджер по продажам».

5. **Назначьте дополнительные наборы разрешений** (при необходимости):
   - На детальной странице пользователя перейдите на вкладку **«Наборы разрешений»**.
   - Нажмите **«Назначить набор»** и выберите нужный.

### Сценарий 4: Ограничить доступ пользователю с помощью Deny

1. Создайте **deny-набор разрешений:**
   - Перейдите в **Наборы разрешений** → **«Создать набор»**.
   - API Name: `no_delete_invoices`, Название: «Запрет удаления счетов», Тип: `Deny`.
2. На вкладке **«Права на объекты»** — отметьте чекбокс **Удаление** для объекта `Invoice__c`.
3. Назначьте этот набор пользователю:
   - Откройте детальную страницу пользователя → вкладка **«Наборы разрешений»** → **«Назначить набор»** → выберите «Запрет удаления счетов».

Теперь, даже если профиль пользователя разрешает удаление счетов, deny-набор его заблокирует.

### Сценарий 5: Передать пользователю другую роль

1. Перейдите в **Пользователи** → откройте нужного пользователя.
2. На вкладке **«Основное»** измените значение в поле **Роль**.
3. Нажмите **«Сохранить»**.

Членство в ролевых группах пересчитается автоматически.

### Сценарий 6: Настроить видимость объекта

1. Перейдите в **Объекты** → откройте нужный объект.
2. В поле **«Видимость (OWD)»** выберите нужное значение:
   - `private` — записи видит только владелец (по умолчанию).
   - `public_read` — все могут читать, обновлять — только владелец.
   - `public_read_write` — полный доступ для всех (share-таблица не создаётся).
   - `controlled_by_parent` — доступ определяется родительским объектом.
3. Нажмите **«Сохранить»**.

> **Внимание:** При смене с `public_read_write` на любой другой режим создаётся share-таблица. При смене на `public_read_write` — share-таблица удаляется вместе со всеми записями шаринга.

### Сценарий 7: Расшарить записи отделу продаж

1. **Создайте правило совместного доступа:**
   - Объект: выберите нужный (например, `Invoice__c`).
   - Тип правила: `owner_based`.
   - Исходная группа: `role_sales_manager` (владельцы записей — менеджеры).
   - Целевая группа: `role_and_sub_sales_director` (доступ — директор и все подчинённые).
   - Уровень доступа: `read`.

Теперь все записи, принадлежащие менеджерам по продажам, будут видны директору по продажам и его подчинённым.

### Сценарий 8: Предоставить ручной доступ к конкретной записи

1. Вызовите API ручного шаринга:
   - Таблица: `obj_invoice` (имя таблицы объекта).
   - ID записи: UUID конкретного счёта.
   - Группа: UUID персональной группы пользователя (или публичной группы).
   - Уровень доступа: `read_write`.

Запись появится в share-таблице `obj_invoice__share` с причиной `manual`.

### Сценарий 9: Создать публичную группу для проектной команды

1. Создайте группу типа `public`:
   - API Name: `project_alpha_team`
   - Название: «Команда проекта Alpha»
2. Добавьте участников — по одному пользователю или целой группе.
3. Используйте эту группу в правилах совместного доступа или для ручного шаринга.

---

*Документ создан для CRM Platform. Актуален для Phase 2a–2c (Identity + Permission engine, RLS core, Groups).*
