# Руководство администратора CRM

## Оглавление

1. [Введение](#1-введение)
2. [Авторизация](#2-авторизация)
   - [Вход в систему](#21-вход-в-систему)
   - [Токены доступа](#22-токены-доступа)
   - [Восстановление пароля](#23-восстановление-пароля)
   - [Установка пароля администратором](#24-установка-пароля-администратором)
   - [Выход из системы](#25-выход-из-системы)
   - [Текущий пользователь](#26-текущий-пользователь)
3. [Ключевые концепции](#3-ключевые-концепции)
4. [Управление метаданными](#4-управление-метаданными)
   - [Объекты](#41-объекты)
   - [Поля](#42-поля)
5. [Управление безопасностью](#5-управление-безопасностью)
   - [Роли](#51-роли)
   - [Наборы разрешений](#52-наборы-разрешений)
   - [Профили](#53-профили)
   - [Пользователи](#54-пользователи)
   - [Группы](#55-группы)
   - [Правила совместного доступа](#56-правила-совместного-доступа)
   - [Ручной шаринг](#57-ручной-шаринг)
6. [SOQL — язык запросов](#6-soql--язык-запросов)
   - [Синтаксис](#61-синтаксис)
   - [Операторы и функции](#62-операторы-и-функции)
   - [Дата-литералы](#63-дата-литералы)
   - [Связи и подзапросы](#64-связи-и-подзапросы)
   - [Безопасность в SOQL](#65-безопасность-в-soql)
   - [API](#66-api)
   - [Лимиты](#67-лимиты)
7. [DML — язык манипуляции данными](#7-dml--язык-манипуляции-данными)
   - [INSERT](#71-insert)
   - [UPDATE](#72-update)
   - [DELETE](#73-delete)
   - [UPSERT](#74-upsert)
   - [Функции в DML](#75-функции-в-dml)
   - [Безопасность в DML](#76-безопасность-в-dml)
   - [API](#77-api)
   - [Лимиты](#78-лимиты)
8. [Управление территориями (Enterprise)](#8-управление-территориями-enterprise)
   - [Модели территорий](#81-модели-территорий)
   - [Территории](#82-территории)
   - [Настройки объектов](#83-настройки-объектов-по-умолчанию)
   - [Назначение пользователей](#84-назначение-пользователей)
   - [Назначение записей](#85-назначение-записей)
   - [Правила назначения](#86-правила-назначения)
9. [Типичные сценарии](#9-типичные-сценарии)

---

## 1. Введение

### Назначение

Админ-панель CRM предназначена для системных администраторов и позволяет:

- Управлять **метаданными** — определять объекты и их поля (схему данных), настраивать видимость объектов (OWD).
- Управлять **безопасностью** — настраивать роли, профили, наборы разрешений, пользователей, группы, правила совместного доступа и ручной шаринг записей.

### Для кого

Документ предназначен для системного администратора, ответственного за конфигурацию CRM-платформы: создание структуры данных, настройку прав доступа и управление пользователями.

### Навигация

Админ-панель доступна по адресу `/admin`. Интерфейс состоит из двух частей:

- **Боковая панель** (слева, ширина 240px) — навигация по разделам.
- **Основная область** (справа) — содержимое выбранного раздела.

Структура боковой панели:

| Пункт | Маршрут |
|-------|---------|
| **Объекты** | `/admin/metadata/objects` |
| **Безопасность** (группа, раскрывается) | |
| — Роли | `/admin/security/roles` |
| — Наборы разрешений | `/admin/security/permission-sets` |
| — Профили | `/admin/security/profiles` |
| **Пользователи** | `/admin/security/users` |

Группа «Безопасность» раскрывается автоматически при переходе к любому из её подразделов.

Все страницы деталей содержат **хлебные крошки** (breadcrumbs) для удобной навигации назад.

### Общие элементы интерфейса

- **Таблицы** с постраничной навигацией (20 записей на страницу). Кнопки «Назад» / «Вперёд» появляются при наличии нескольких страниц.
- **Меню действий** (три вертикальные точки) в каждой строке таблицы — содержит пункты «Открыть» и «Удалить».
- **Диалог подтверждения удаления** — перед удалением любой сущности система запрашивает подтверждение.
- **Toast-уведомления** — сообщения об успешных операциях и ошибках.

---

## 2. Авторизация

Для работы с админ-панелью необходимо пройти аутентификацию. Система использует JWT (JSON Web Token) — стандартный механизм авторизации для REST API.

### 2.1. Вход в систему

**Маршрут:** `/login`

Страница входа содержит форму:

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Имя пользователя | Текст | Да | Username учётной записи |
| Пароль | Пароль | Да | Пароль учётной записи |

Кнопка **«Войти»** — отправляет запрос аутентификации. При успехе — перенаправление в админ-панель (`/admin`).

Ссылка **«Забыли пароль?»** — переход на страницу восстановления пароля.

**Ограничение попыток:** Эндпоинт входа ограничен — не более 5 попыток за 15 минут с одного IP-адреса. При превышении лимита запросы отклоняются с ошибкой 429 (Too Many Requests).

### 2.2. Токены доступа

Система использует JWT-аутентификацию с двумя типами токенов:

| Токен | Время жизни | Назначение |
|-------|-------------|------------|
| **Access token** | 15 минут | Авторизация API-запросов (заголовок `Authorization: Bearer <token>`) |
| **Refresh token** | 7 дней | Получение новой пары токенов без повторного ввода пароля |

**Автоматическое обновление:** При истечении access token фронтенд автоматически запрашивает новую пару токенов с помощью refresh token. Если refresh token тоже истёк — пользователь перенаправляется на страницу входа.

**Ротация токенов:** При каждом обновлении (refresh) старый refresh token аннулируется и выпускается новый. Это защищает от повторного использования перехваченных токенов.

**Хранение:** Refresh token хранится на сервере в виде SHA-256 хеша. Сырой токен не сохраняется — при утечке базы данных токены невозможно использовать.

### 2.3. Восстановление пароля

#### Запрос сброса

**Маршрут:** `/forgot-password`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Email | Email | Да | Электронная почта, привязанная к учётной записи |

Кнопка **«Отправить»** — инициирует отправку письма со ссылкой для сброса пароля. Система всегда отвечает успехом, даже если указанный email не зарегистрирован (для защиты от перечисления пользователей).

Ссылка **«Вернуться ко входу»** — возврат на страницу входа.

#### Сброс пароля

**Маршрут:** `/reset-password?token=<token>`

Пользователь переходит по ссылке из письма. Форма содержит:

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Новый пароль | Пароль | Да | Новый пароль (минимум 8 символов, максимум 128) |
| Подтверждение пароля | Пароль | Да | Повтор нового пароля |

Кнопка **«Сбросить пароль»** — устанавливает новый пароль. После сброса все активные сессии пользователя аннулируются (refresh tokens удаляются), и пользователь перенаправляется на страницу входа.

Токен сброса действителен **1 час** и может быть использован только один раз.

### 2.4. Установка пароля администратором

Администратор может установить пароль для любого пользователя через API:

**Маршрут:** `PUT /api/v1/admin/security/users/:id/password`

Тело запроса:
```json
{
  "password": "новый_пароль"
}
```

Требования к паролю: минимум 8 символов, максимум 128 символов.

#### Начальный пароль администратора

При первом запуске системы пароль для учётной записи системного администратора задаётся через переменную окружения:

```
ADMIN_INITIAL_PASSWORD=your-secure-password
```

Пароль устанавливается однократно: если у администратора уже задан пароль, переменная окружения игнорируется.

### 2.5. Выход из системы

**Кнопка «Выйти»** расположена в нижней части боковой панели (рядом с именем текущего пользователя).

При выходе:
- Текущий refresh token аннулируется на сервере.
- Локальные токены удаляются из браузера.
- Пользователь перенаправляется на страницу входа.

Для завершения **всех** активных сессий (например, при подозрении на компрометацию) используйте API:

```
POST /api/v1/auth/logout-all
```

Это удалит все refresh tokens пользователя.

### 2.6. Текущий пользователь

**Маршрут API:** `GET /api/v1/auth/me`

Возвращает информацию о текущем авторизованном пользователе:

| Поле | Описание |
|------|----------|
| `id` | UUID пользователя |
| `username` | Имя пользователя |
| `email` | Электронная почта |
| `first_name` | Имя |
| `last_name` | Фамилия |
| `profile_id` | UUID назначенного профиля |
| `role_id` | UUID назначенной роли (или `null`) |
| `is_active` | Статус активности |

Имя текущего пользователя отображается в нижней части боковой панели админки.

---

## 3. Ключевые концепции

### Модель безопасности

Система безопасности CRM реализует три слоя контроля доступа:

1. **OLS (Object-Level Security)** — права на уровне объекта. Определяет, какие CRUD-операции разрешены для данного объекта.
2. **FLS (Field-Level Security)** — права на уровне поля. Определяет, какие поля пользователь может читать и/или редактировать.
3. **RLS (Row-Level Security)** — права на уровне записи. Определяет, какие конкретно записи видит пользователь на основе OWD-видимости объекта, иерархии ролей, групп, правил совместного доступа и ручного шаринга.

### Иерархия сущностей безопасности

```
Профиль (Profile)
  └── Базовый набор разрешений (base Permission Set, тип grant)
        ├── OLS: права на объекты
        └── FLS: права на поля

Пользователь (User)
  ├── Профиль (ровно один, обязательный)
  ├── Роль (опциональная, используется для RLS)
  ├── Дополнительные наборы разрешений (grant и/или deny)
  └── Группы (автоматические и ручные)

Группы (Groups)
  ├── Personal — одна на пользователя (авто-создание)
  ├── Role — одна на роль (авто-создание)
  ├── Role & Subordinates — одна на роль (авто-создание)
  └── Public — создаются администратором

Правила совместного доступа (Sharing Rules)
  ├── Owner-based — на основе владельца записи
  └── Criteria-based — на основе значения поля записи
```

### OWD (Organization-Wide Defaults) — видимость объекта

Видимость (OWD) определяет **базовый уровень доступа** ко всем записям объекта для всех пользователей. Это отправная точка RLS — далее доступ расширяется через иерархию ролей, группы и правила шаринга.

| Видимость | Описание |
|-----------|----------|
| `private` | Пользователь видит только свои записи (по полю `owner_id`). Доступ расширяется через иерархию ролей, группы и шаринг. |
| `public_read` | Все пользователи могут читать все записи. Обновление — только владелец, иерархия или шаринг. |
| `public_read_write` | Полный доступ для всех. RLS-фильтрация отключена. Share-таблица не создаётся. |
| `controlled_by_parent` | Доступ определяется родительским объектом (для композиционных связей). |

Видимость задаётся при создании объекта и может быть изменена позднее. При смене видимости система автоматически создаёт или удаляет share-таблицу.

### Группы

Группы — это механизм объединения пользователей для целей шаринга. Все операции шаринга (ручной, через правила) выполняются через группы.

| Тип группы | Описание | Создание |
|------------|----------|----------|
| `personal` | Содержит одного пользователя | Автоматически при создании пользователя |
| `role` | Содержит всех пользователей с данной ролью | Автоматически при создании роли |
| `role_and_subordinates` | Содержит пользователей с данной ролью и всех подчинённых ролей | Автоматически при создании роли |
| `public` | Произвольная группа пользователей | Вручную администратором |

При изменении роли пользователя его членство в ролевых группах пересчитывается автоматически.

### Принцип вычисления эффективных прав

```
effective = grants & ~denies
```

1. Базовые права определяются **профилем** пользователя (через его базовый набор разрешений).
2. Дополнительные **grant-наборы** расширяют права (битовое ИЛИ).
3. **Deny-наборы** глобально подавляют указанные права (битовое И с инверсией).

Deny всегда побеждает Grant.

### Bitmask-модель прав

**OLS (права на объект):**

| Бит | Значение | Операция |
|-----|----------|----------|
| 1   | `0001`   | Чтение   |
| 2   | `0010`   | Создание |
| 4   | `0100`   | Обновление |
| 8   | `1000`   | Удаление |

Полный доступ = `15` (все 4 бита установлены).

**FLS (права на поле):**

| Бит | Значение | Операция |
|-----|----------|----------|
| 1   | `01`     | Чтение   |
| 2   | `10`     | Запись   |

Полный доступ = `3` (оба бита установлены).

### Роли

Роли образуют **иерархию** (дерево). Они используются для Row-Level Security:

- Пользователь с более высокой ролью в иерархии может видеть записи подчинённых (только чтение).
- У пользователя может быть ровно одна роль (или ни одной).

---

## 4. Управление метаданными

### 4.1. Объекты

Объект — это описание сущности в системе (аналог таблицы). Каждый объект хранит метаданные: имя, тип, флаги поведения.

#### Список объектов

**Маршрут:** `/admin/metadata/objects`

Страница отображает таблицу со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор объекта (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Тип | `standard` или `custom` (отображается бейджем) |
| Создан | Дата создания |

**Фильтрация:** выпадающий список для фильтрации по типу объекта:
- Все типы
- Standard
- Custom

**Действия:**
- Кнопка **«Создать объект»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить» (удаление доступно только если `isDeleteableObject = true` и `isPlatformManaged = false`).

#### Создание объекта

**Маршрут:** `/admin/metadata/objects/new`

Форма состоит из двух карточек:

**Карточка «Основная информация»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя объекта (например, `Invoice__c`). Задаётся при создании, далее не редактируется. |
| Название | Текст | Да | Отображаемое имя в единственном числе (например, «Счёт») |
| Мн. число | Текст | Да | Название во множественном числе (например, «Счета») |
| Тип объекта | Выбор | Да | `standard` или `custom`. Задаётся при создании, далее не редактируется. |
| Видимость (OWD) | Выбор | Нет | Базовый уровень доступа к записям: `private` (по умолчанию), `public_read`, `public_read_write`, `controlled_by_parent`. См. [OWD](#owd-organization-wide-defaults--видимость-объекта). |
| Описание | Многострочный текст | Нет | Произвольное описание объекта |

**Карточка флагов** (три группы чекбоксов):

**Группа «Разрешения на записи»:**

| Флаг | Описание |
|------|----------|
| `isCreateable` | Разрешено создание записей этого объекта |
| `isUpdateable` | Разрешено обновление записей |
| `isDeleteable` | Разрешено удаление записей |
| `isQueryable` | Объект доступен для запросов через SOQL |
| `isSearchable` | Объект доступен для полнотекстового поиска |

**Группа «Настройки объекта»:**

| Флаг | Описание |
|------|----------|
| `isVisibleInSetup` | Объект отображается в интерфейсе настроек |
| `isCustomFieldsAllowed` | К объекту можно добавлять пользовательские поля |
| `isDeleteableObject` | Сам объект можно удалить |

**Группа «Возможности»:**

| Флаг | Описание |
|------|----------|
| `hasActivities` | Поддержка активностей (задачи, события) |
| `hasNotes` | Поддержка заметок |
| `hasHistoryTracking` | Ведение истории изменений |
| `hasSharingRules` | Поддержка правил общего доступа (RLS) |

После нажатия **«Создать»** происходит переход на детальную страницу созданного объекта.

#### Редактирование объекта

**Маршрут:** `/admin/metadata/objects/:objectId`

Детальная страница содержит две вкладки:

**Вкладка «Основное»:**
- Все те же поля, что при создании, но **API Name** и **Тип объекта** — только для чтения (disabled).
- Название, Мн. число, Описание, **Видимость (OWD)** и все флаги — редактируемые.
- При изменении видимости с/на `public_read_write` система автоматически создаёт или удаляет share-таблицу объекта.
- Кнопка **«Сохранить»** — сохраняет изменения.

**Вкладка «Поля (N)»:**
- Отображает таблицу полей объекта (см. [4.2. Поля](#42-поля)).
- В заголовке вкладки показано количество полей.

**Удаление объекта:**
- Кнопка **«Удалить объект»** (красная, в правом верхнем углу) видна только если `isDeleteableObject = true` и `isPlatformManaged = false`.
- Удаление требует подтверждения. Текст предупреждения: *«Объект «{label}» ({apiName}) и все его поля будут удалены без возможности восстановления»*.

### 4.2. Поля

Поле — это атрибут объекта (аналог колонки таблицы). Каждое поле имеет тип, подтип и дополнительную конфигурацию.

#### Таблица полей

Таблица полей отображается на вкладке «Поля» детальной страницы объекта. Для каждого поля отображаются: API Name, Название, Тип, Подтип, флаги «Обязательное» и «Уникальное».

Действия:
- Кнопка **«Добавить поле»** — открывает диалог создания.
- Кнопка **«Редактировать»** — открывает диалог редактирования.
- Кнопка **«Удалить»** — удаляет поле (с подтверждением).

#### Типы и подтипы полей

| Тип | Русское название | Доступные подтипы |
|-----|-----------------|-------------------|
| `text` | Текст | `plain` (Простой текст), `area` (Многострочный), `rich` (Форматированный), `email` (Email), `phone` (Телефон), `url` (URL) |
| `number` | Число | `integer` (Целое), `decimal` (Десятичное), `currency` (Валюта), `percent` (Процент), `auto_number` (Авто-номер) |
| `boolean` | Логический | — (без подтипов) |
| `datetime` | Дата/Время | `date` (Дата), `datetime` (Дата и время), `time` (Время) |
| `picklist` | Список выбора | `single` (Одиночный), `multi` (Множественный) |
| `reference` | Связь | `association` (Ассоциация), `composition` (Композиция), `polymorphic` (Полиморфная) |

#### Создание поля

Диалог создания поля содержит следующие поля:

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя поля в рамках объекта |
| Название | Текст | Да | Отображаемое имя поля |
| Тип | Выбор | Да | Один из шести типов: text, number, boolean, datetime, picklist, reference |
| Подтип | Выбор | Зависит от типа | Список доступных подтипов зависит от выбранного типа. Для boolean подтипы отсутствуют. |
| Ссылочный объект | Выбор | Для reference | Объект, на который ссылается поле |
| Описание | Текст | Нет | Описание поля |
| Help Text | Текст | Нет | Текст-подсказка для пользователей |
| Обязательное | Чекбокс | Нет | Делает поле обязательным для заполнения |
| Уникальное | Чекбокс | Нет | Значение поля должно быть уникальным |
| Пользовательское | Чекбокс | Нет | Отмечает поле как custom |
| Порядок сортировки | Число | Нет | Порядок отображения поля |

#### Конфигурация поля по типу/подтипу

В зависимости от выбранной комбинации тип/подтип доступны дополнительные поля конфигурации:

**Текстовые поля (text/plain, text/area, text/rich):**

| Параметр | Описание |
|----------|----------|
| Макс. длина | Максимальная длина текста |
| Значение по умолчанию | Значение, подставляемое при создании записи |

**Текстовые (email, phone, url):**

| Параметр | Описание |
|----------|----------|
| Макс. длина | Максимальная длина текста |

**Целое число (number/integer):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | Значение по умолчанию |

**Десятичное / Валюта / Процент (number/decimal, number/currency, number/percent):**

| Параметр | Описание |
|----------|----------|
| Точность (всего цифр) | Общее количество значащих цифр |
| Масштаб (после запятой) | Количество знаков после десятичной точки |
| Значение по умолчанию | Значение по умолчанию |

**Авто-номер (number/auto_number):**

| Параметр | Описание |
|----------|----------|
| Формат | Шаблон нумерации, например `INV-{0000}` |
| Начальное значение | Стартовое значение счётчика |

**Логический (boolean):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | `true` или `false` |

**Дата/Время (datetime/date, datetime/datetime, datetime/time):**

| Параметр | Описание |
|----------|----------|
| Значение по умолчанию | Значение по умолчанию |

**Ассоциация (reference/association):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `set_null` (Очистить) или `restrict` (Запретить) |

**Композиция (reference/composition):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `cascade` (Каскадное удаление) или `restrict` (Запретить) |
| Можно переназначить родителя | Разрешена ли смена родительского объекта |

**Полиморфная связь (reference/polymorphic):**

| Параметр | Описание |
|----------|----------|
| Имя связи | Имя обратной связи |
| При удалении | `set_null` (Очистить) или `restrict` (Запретить) |

#### Редактирование поля

Диалог редактирования позволяет изменить:
- Название
- Описание
- Help Text
- Обязательное (чекбокс)
- Уникальное (чекбокс)
- Параметры конфигурации (зависят от типа/подтипа)
- Порядок сортировки

**API Name**, **Тип** и **Подтип** — не редактируются после создания.

#### Удаление поля

Удаление поля выполняется через кнопку «Удалить» в таблице полей. Операция необратима.

---

## 5. Управление безопасностью

### 5.1. Роли

Роли определяют положение пользователя в организационной иерархии. Используются для Row-Level Security: пользователи с более высокой ролью получают доступ на чтение записей подчинённых.

#### Список ролей

**Маршрут:** `/admin/security/roles`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор роли (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Родительская роль | Название роли-родителя или «—» для корневых ролей |
| Создан | Дата создания |

Действия:
- Кнопка **«Создать роль»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание роли

**Маршрут:** `/admin/security/roles/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя роли (например, `sales_manager`). Задаётся при создании, далее не редактируется. |
| Название | Текст | Да | Отображаемое имя (например, «Менеджер по продажам») |
| Родительская роль | Выбор | Нет | Выбор из списка существующих ролей. Вариант «Без родителя» — корневая роль. |
| Описание | Многострочный текст | Нет | Произвольное описание роли |

После создания происходит переход на детальную страницу роли.

> **Автоматические группы:** При создании роли система автоматически создаёт две группы: `role_{api_name}` (все пользователи с данной ролью) и `role_and_sub_{api_name}` (пользователи с данной ролью и подчинёнными ролями).

#### Редактирование роли

**Маршрут:** `/admin/security/roles/:roleId`

- **API Name** — только для чтения.
- **Название**, **Родительская роль**, **Описание** — редактируемые.
- В списке родительских ролей исключена текущая роль (нельзя назначить роль родителем самой себя).
- Кнопка **«Сохранить»** — сохраняет изменения.

#### Удаление роли

Кнопка **«Удалить роль»** (красная) в правом верхнем углу детальной страницы. Требует подтверждения.

### 5.2. Наборы разрешений

Набор разрешений (Permission Set) — это контейнер для OLS- и FLS-прав. Бывает двух типов:

- **Grant** — расширяет права (разрешает операции).
- **Deny** — глобально подавляет права (запрещает операции, даже если они разрешены в других наборах).

#### Список наборов разрешений

**Маршрут:** `/admin/security/permission-sets`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Тип | `Grant` или `Deny` (отображается бейджем) |
| Создан | Дата создания |

**Фильтрация:** выпадающий список для фильтрации по типу:
- Все типы
- Grant
- Deny

Действия:
- Кнопка **«Создать набор»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание набора разрешений

**Маршрут:** `/admin/security/permission-sets/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя (например, `sales_read_access`). Не редактируется после создания. |
| Название | Текст | Да | Отображаемое имя (например, «Доступ на чтение продаж») |
| Тип | Выбор | Да | `Grant (разрешает)` или `Deny (запрещает)`. Не редактируется после создания. |
| Описание | Многострочный текст | Нет | Произвольное описание |

#### Детальная страница набора разрешений

**Маршрут:** `/admin/security/permission-sets/:permissionSetId`

Содержит три вкладки:

**Вкладка «Основное»:**
- API Name (только чтение), Название, Тип (только чтение), Описание.
- Кнопка «Сохранить» для сохранения изменений названия и описания.

**Вкладка «Права на объекты» (OLS):**

Таблица, где каждая строка — это объект из метаданных. Для каждого объекта отображается группа чекбоксов:

| Чекбокс | Бит | Описание |
|---------|-----|----------|
| Чтение | 1 | Право на чтение записей объекта |
| Создание | 2 | Право на создание записей |
| Обновление | 4 | Право на обновление записей |
| Удаление | 8 | Право на удаление записей |

Изменения сохраняются **мгновенно** при переключении чекбокса (без нажатия кнопки «Сохранить»).

**Вкладка «Права на поля» (FLS):**

1. Сначала нужно выбрать объект из выпадающего списка.
2. После выбора отображается таблица полей этого объекта. Для каждого поля — группа чекбоксов:

| Чекбокс | Бит | Описание |
|---------|-----|----------|
| Чтение | 1 | Право на чтение значения поля |
| Запись | 2 | Право на изменение значения поля |

Изменения также сохраняются **мгновенно**.

#### Удаление набора разрешений

Кнопка **«Удалить набор»** (красная) в правом верхнем углу. Требует подтверждения.

### 5.3. Профили

Профиль — это обязательная сущность безопасности, назначаемая каждому пользователю. При создании профиля автоматически создаётся **базовый набор разрешений** (grant-тип), который определяет начальные права пользователя.

#### Список профилей

**Маршрут:** `/admin/security/profiles`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| API Name | Уникальный идентификатор (ссылка на детальную страницу) |
| Название | Человекочитаемое название |
| Создан | Дата создания |

Действия:
- Кнопка **«Создать профиль»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание профиля

**Маршрут:** `/admin/security/profiles/new`

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя (например, `sales_profile`). Не редактируется после создания. |
| Название | Текст | Да | Отображаемое имя (например, «Профиль менеджера») |
| Описание | Многострочный текст | Нет | Произвольное описание |

При создании профиля система автоматически генерирует базовый набор разрешений (grant).

#### Редактирование профиля

**Маршрут:** `/admin/security/profiles/:profileId`

- API Name (только чтение), Название, Описание — редактируемые.
- Ссылка **«Открыть базовый набор разрешений»** — переход на страницу редактирования базового набора разрешений профиля, где настраиваются OLS и FLS.
- Кнопка **«Сохранить»** — сохраняет изменения названия и описания.

> **Важно:** Для настройки OLS/FLS профиля необходимо перейти к его базовому набору разрешений через ссылку на детальной странице профиля.

#### Удаление профиля

Кнопка **«Удалить профиль»** (красная) в правом верхнем углу. Требует подтверждения.

### 5.4. Пользователи

Пользователь — это учётная запись человека в системе. Каждому пользователю назначается профиль (обязательно) и опционально — роль и дополнительные наборы разрешений.

#### Список пользователей

**Маршрут:** `/admin/security/users`

Таблица со следующими колонками:

| Колонка | Описание |
|---------|----------|
| Username | Имя пользователя (ссылка на детальную страницу) |
| Email | Электронная почта |
| Имя | Полное имя (имя + фамилия) |
| Профиль | Название назначенного профиля |
| Роль | Название назначенной роли или «—» |
| Статус | Бейдж «Активен» / «Неактивен» |

Действия:
- Кнопка **«Создать пользователя»** — переход к форме создания.
- Контекстное меню строки — «Открыть» и «Удалить».

#### Создание пользователя

**Маршрут:** `/admin/security/users/new`

Форма состоит из трёх карточек:

**Карточка «Учётные данные»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Имя пользователя | Текст | Да | Уникальное имя для входа (например, `john.doe`). Не редактируется после создания. |
| Email | Email | Да | Электронная почта |

**Карточка «Личные данные»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Имя | Текст | Нет | Имя пользователя |
| Фамилия | Текст | Нет | Фамилия пользователя |

**Карточка «Безопасность»:**

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Профиль | Выбор | Да | Выбор из списка созданных профилей |
| Роль | Выбор | Нет | Выбор из списка ролей. Вариант «Без роли» — пользователь не входит в иерархию. |

> **Автоматические действия при создании:** Система автоматически создаёт персональную группу `personal_{username}` и добавляет пользователя в неё, а также в ролевые группы (если роль указана).

#### Редактирование пользователя

**Маршрут:** `/admin/security/users/:userId`

Содержит две вкладки:

**Вкладка «Основное»:**

- **Имя пользователя** — только для чтения.
- **Email**, **Имя**, **Фамилия** — редактируемые.
- **Профиль** и **Роль** — изменяемые через выпадающие списки. При смене роли членство в ролевых группах пересчитывается автоматически.
- **Активен** — переключатель (Switch). Неактивный пользователь не может войти в систему.
- Кнопка **«Сохранить»** — сохраняет изменения.

**Вкладка «Наборы разрешений»:**

Управление дополнительными наборами разрешений, назначенными пользователю.

Таблица назначенных наборов:

| Колонка | Описание |
|---------|----------|
| Название | Название набора разрешений |
| Тип | `Grant` или `Deny` (бейдж) |
| Назначен | Дата назначения |
| Действие | Кнопка «Отозвать» |

Действия:
- Кнопка **«Назначить набор»** — открывает диалог назначения. В диалоге доступен выпадающий список с наборами разрешений, которые ещё не назначены данному пользователю. Рядом с каждым набором показан его тип (grant/deny).
- Кнопка **«Отозвать»** — отзывает набор разрешений у пользователя (с подтверждением).

#### Удаление пользователя

Кнопка **«Удалить пользователя»** (красная) в правом верхнем углу. Требует подтверждения.

### 5.5. Группы

Группы объединяют пользователей для целей шаринга. Все записи шарятся именно группам, а не отдельным пользователям.

#### Автоматические группы

Три типа групп создаются автоматически и не управляются вручную:

- **Personal** — создаётся при создании пользователя. Содержит ровно одного пользователя. API Name: `personal_{username}`.
- **Role** — создаётся при создании роли. Содержит всех пользователей с данной ролью. API Name: `role_{api_name}`.
- **Role & Subordinates** — создаётся при создании роли. Содержит пользователей с данной ролью и со всех подчинённых ролей. API Name: `role_and_sub_{api_name}`.

Членство в этих группах пересчитывается автоматически при изменении роли пользователя или иерархии ролей.

#### Публичные группы

Публичные группы (`public`) создаются администратором вручную и позволяют объединять пользователей произвольным образом.

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| API Name | Текст | Да | Уникальное имя группы |
| Название | Текст | Да | Отображаемое имя |
| Тип | Выбор | Да | `personal`, `role`, `role_and_subordinates` или `public` |

#### Членство в группах

В группу можно добавить:
- **Пользователя** (по `member_user_id`).
- **Другую группу** (по `member_group_id`) — все члены вложенной группы становятся членами родительской.

> **Ограничение:** В одном добавлении указывается либо пользователь, либо группа — не оба одновременно.

Эффективное членство (с учётом вложенных групп) вычисляется автоматически и хранится в кэше `security.effective_group_members`.

### 5.6. Правила совместного доступа

Правила совместного доступа (Sharing Rules) расширяют видимость записей объекта для определённых групп пользователей. Правила работают аддитивно — они только добавляют доступ, но не могут его ограничить.

#### Типы правил

| Тип | Описание |
|-----|----------|
| `owner_based` | Записи, принадлежащие пользователям из **исходной группы**, становятся видны пользователям из **целевой группы**. |
| `criteria_based` | Записи, удовлетворяющие критерию (поле + оператор + значение), становятся видны пользователям из **целевой группы**. |

#### Создание правила

| Поле | Тип | Обязательное | Описание |
|------|-----|:---:|----------|
| Объект | UUID | Да | Объект, к которому применяется правило |
| Тип правила | Выбор | Да | `owner_based` или `criteria_based` |
| Исходная группа | UUID | Да | Группа владельцев записей (для owner_based) |
| Целевая группа | UUID | Да | Группа, которой предоставляется доступ |
| Уровень доступа | Выбор | Да | `read` — только чтение, `read_write` — чтение и запись |
| Поле критерия | Текст | Для criteria_based | Имя поля для фильтрации (например, `status`) |
| Оператор критерия | Текст | Для criteria_based | Оператор сравнения (например, `equals`) |
| Значение критерия | Текст | Для criteria_based | Значение для сравнения (например, `closed`) |

> **Примечание:** Генерация записей в share-таблицах на основе правил выполняется в Phase 3/4 (DML engine). Phase 2b хранит определения правил и генерирует outbox-события для пересчёта кэшей.

### 5.7. Ручной шаринг

Ручной шаринг позволяет предоставить доступ к конкретной записи определённой группе пользователей. Запись добавляется в share-таблицу объекта с причиной `manual`.

#### Предоставление доступа (Share)

| Параметр | Тип | Описание |
|----------|-----|----------|
| Таблица | Текст | Имя таблицы объекта (например, `obj_invoice`) |
| ID записи | UUID | Идентификатор записи, к которой предоставляется доступ |
| Группа | UUID | Идентификатор группы, которой предоставляется доступ |
| Уровень доступа | Выбор | `read` или `read_write` |

При повторном шаринге той же записи той же группе уровень доступа обновляется.

#### Отзыв доступа (Revoke)

Удаляет запись из share-таблицы с причиной `manual` для указанной пары (запись, группа).

#### Просмотр шарингов

Возвращает список всех записей из share-таблицы для конкретной записи (все причины: `manual`, `sharing_rule`, `territory`).

### Как RLS определяет видимость записи

Для объекта с видимостью `private` или `controlled_by_parent` пользователь видит запись, если выполняется хотя бы одно условие:

1. **Владелец** — пользователь является владельцем записи (`owner_id`).
2. **Иерархия ролей** — пользователь находится выше владельца в иерархии ролей (только чтение).
3. **Share-таблица** — запись расшарена группе, в которую входит пользователь (через ручной шаринг, правила или территории).

Для `public_read` — все могут читать; обновление — по тем же правилам, что `private`.
Для `public_read_write` — RLS-фильтрация полностью отключена.

---

## 6. SOQL — язык запросов

SOQL (Structured Object Query Language) — встроенный язык запросов платформы. Все операции чтения данных проходят через SOQL с автоматическим применением OLS, FLS и RLS.

### 6.1. Синтаксис

#### Базовая структура

```
SELECT <поля> FROM <объект>
[WHERE <условие>]
[GROUP BY <поля>]
[HAVING <условие>]
[ORDER BY <поля> [ASC|DESC] [NULLS FIRST|LAST]]
[LIMIT <число>]
[OFFSET <число>]
[FOR UPDATE]
```

#### Примеры запросов

Простой запрос:
```
SELECT Id, Name, Email FROM Contact WHERE Status = 'Active'
```

С сортировкой и ограничением:
```
SELECT Id, Name, Amount FROM Deal ORDER BY Amount DESC LIMIT 10
```

Группировка с агрегатами:
```
SELECT Status, COUNT(), SUM(Amount) FROM Deal GROUP BY Status HAVING COUNT() > 5
```

Алиасы полей:
```
SELECT Name AS ContactName, Email AS ContactEmail FROM Contact
```

### 6.2. Операторы и функции

#### Операторы сравнения

| Оператор | Описание | Пример |
|----------|----------|--------|
| `=` или `==` | Равно | `WHERE Status = 'Active'` |
| `!=` или `<>` | Не равно | `WHERE Status != 'Closed'` |
| `>` | Больше | `WHERE Amount > 1000` |
| `<` | Меньше | `WHERE Amount < 500` |
| `>=` | Больше или равно | `WHERE CreatedAt >= 2024-01-01` |
| `<=` | Меньше или равно | `WHERE Amount <= 10000` |

#### Логические операторы

| Оператор | Пример |
|----------|--------|
| `AND` | `WHERE Status = 'Active' AND Amount > 1000` |
| `OR` | `WHERE Status = 'Closed' OR Status = 'Won'` |
| `NOT` | `WHERE NOT IsDeleted` |

#### Специальные операторы

| Оператор | Описание | Пример |
|----------|----------|--------|
| `IS NULL` | Проверка на NULL | `WHERE Phone IS NULL` |
| `IS NOT NULL` | Проверка на не-NULL | `WHERE Email IS NOT NULL` |
| `IN` | Вхождение в список | `WHERE Id IN ('001', '002', '003')` |
| `NOT IN` | Невхождение в список | `WHERE Status NOT IN ('Closed', 'Archived')` |
| `LIKE` | Поиск по шаблону | `WHERE Name LIKE 'Acme%'` |
| `NOT LIKE` | Инверсия LIKE | `WHERE Email NOT LIKE '%test%'` |

Шаблоны `LIKE`: `%` — любые символы, `_` — один символ.

#### Агрегатные функции

| Функция | Описание | Пример |
|---------|----------|--------|
| `COUNT()` | Количество записей | `SELECT COUNT() FROM Contact` |
| `COUNT_DISTINCT(field)` | Количество уникальных значений | `SELECT COUNT_DISTINCT(Status) FROM Deal` |
| `SUM(field)` | Сумма | `SELECT SUM(Amount) FROM Deal` |
| `AVG(field)` | Среднее | `SELECT AVG(Amount) FROM Deal` |
| `MIN(field)` | Минимум | `SELECT MIN(CreatedAt) FROM Contact` |
| `MAX(field)` | Максимум | `SELECT MAX(Amount) FROM Deal` |

#### Встроенные функции

**Строковые:**

| Функция | Описание |
|---------|----------|
| `UPPER(str)` | Перевод в верхний регистр |
| `LOWER(str)` | Перевод в нижний регистр |
| `TRIM(str)` | Удаление пробелов по краям |
| `LENGTH(str)` или `LEN(str)` | Длина строки |
| `SUBSTRING(str, start, length)` или `SUBSTR(...)` | Подстрока |
| `CONCAT(str1, str2, ...)` | Конкатенация |

**Числовые:**

| Функция | Описание |
|---------|----------|
| `ABS(num)` | Абсолютное значение |
| `ROUND(num, decimals)` | Округление |
| `FLOOR(num)` | Округление вниз |
| `CEIL(num)` или `CEILING(num)` | Округление вверх |

**Обработка NULL:**

| Функция | Описание |
|---------|----------|
| `COALESCE(expr1, expr2, ...)` | Первое не-NULL значение |
| `NULLIF(expr1, expr2)` | NULL, если значения равны |

### 6.3. Дата-литералы

SOQL поддерживает символические дата-литералы, которые автоматически разрешаются в конкретные даты на момент выполнения запроса.

**Статические литералы:**

| Литерал | Описание |
|---------|----------|
| `TODAY` | Сегодня |
| `YESTERDAY` | Вчера |
| `TOMORROW` | Завтра |
| `THIS_WEEK` / `LAST_WEEK` / `NEXT_WEEK` | Текущая / прошлая / следующая неделя |
| `THIS_MONTH` / `LAST_MONTH` / `NEXT_MONTH` | Текущий / прошлый / следующий месяц |
| `THIS_QUARTER` / `LAST_QUARTER` / `NEXT_QUARTER` | Текущий / прошлый / следующий квартал |
| `THIS_YEAR` / `LAST_YEAR` / `NEXT_YEAR` | Текущий / прошлый / следующий год |
| `LAST_90_DAYS` / `NEXT_90_DAYS` | Последние / следующие 90 дней |
| `THIS_FISCAL_QUARTER` / `THIS_FISCAL_YEAR` | Текущий фискальный квартал / год |

**Параметрические литералы (с указанием N):**

| Литерал | Пример |
|---------|--------|
| `LAST_N_DAYS:N` | `WHERE CreatedAt >= LAST_N_DAYS:30` |
| `NEXT_N_DAYS:N` | `WHERE DueDate <= NEXT_N_DAYS:7` |
| `LAST_N_WEEKS:N` / `NEXT_N_WEEKS:N` | Последние/следующие N недель |
| `LAST_N_MONTHS:N` / `NEXT_N_MONTHS:N` | Последние/следующие N месяцев |
| `LAST_N_QUARTERS:N` / `NEXT_N_QUARTERS:N` | Последние/следующие N кварталов |
| `LAST_N_YEARS:N` / `NEXT_N_YEARS:N` | Последние/следующие N лет |

### 6.4. Связи и подзапросы

#### Lookup-запросы (child → parent)

Используйте точечную нотацию для обращения к полям родительского объекта:

```
SELECT Name, Account.Name, Account.Owner.Name FROM Contact
```

Глубина вложенности — до 5 уровней.

#### Relationship-подзапросы (parent → child)

Для получения дочерних записей используйте подзапросы в SELECT:

```
SELECT Name, (SELECT Email, Phone FROM Contacts) FROM Account
```

Подзапросы поддерживают WHERE, ORDER BY и LIMIT.

#### Semi-join (IN с подзапросом)

```
SELECT Name FROM Contact
WHERE AccountId IN (SELECT Id FROM Account WHERE Industry = 'Tech')
```

#### TYPEOF (полиморфные поля)

Для полиморфных reference-полей:

```
SELECT TYPEOF What
  WHEN Account THEN Name, Industry
  WHEN Opportunity THEN Name, Amount
  ELSE Name
END
FROM Task
```

### 6.5. Безопасность в SOQL

Каждый SOQL-запрос автоматически проходит три уровня security:

1. **OLS** — проверяется право `Read` на объект в SELECT и FROM. Если у пользователя нет доступа к объекту, запрос отклоняется.
2. **FLS** — проверяется право `Read` на каждое поле в SELECT. Системные поля (`Id`, `OwnerId`, `CreatedAt`, `UpdatedAt`, `CreatedById`, `UpdatedById`) доступны всегда.
3. **RLS** — в SQL автоматически инжектируется WHERE-условие, ограничивающее результат записями, видимыми пользователю (на основе OWD, иерархии ролей, групп и шаринга).

### 6.6. API

**GET** `/api/v1/query?q=<SOQL>`

Параметры:
- `q` (обязательный) — строка SOQL-запроса.

Пример:
```
GET /api/v1/query?q=SELECT Id, Name FROM Account LIMIT 10
```

**POST** `/api/v1/query`

Тело запроса:
```json
{
  "query": "SELECT Id, Name FROM Account WHERE Industry = 'Tech'",
  "pageSize": 100
}
```

Ответ:
```json
{
  "totalSize": 3,
  "done": true,
  "records": [
    {"Id": "...", "Name": "Acme Inc"},
    {"Id": "...", "Name": "Globex Corp"},
    {"Id": "...", "Name": "TechStart"}
  ]
}
```

### 6.7. Лимиты

| Параметр | Значение по умолчанию |
|----------|----------------------|
| Максимум записей (LIMIT) | 50 000 |
| Максимум OFFSET | 2 000 |
| Глубина lookup (точечная нотация) | 5 уровней |
| Максимум подзапросов | 20 |
| Записей в подзапросе (per parent) | 200 |
| Длина запроса | 100 000 символов |

---

## 7. DML — язык манипуляции данными

DML (Data Manipulation Language) — встроенный язык для операций записи. Все изменения данных проходят через DML с автоматическим применением OLS и FLS. Для UPDATE и DELETE дополнительно применяется RLS.

### 7.1. INSERT

Вставка одной или нескольких записей.

```
INSERT INTO <объект> (поле1, поле2, ...) VALUES (значение1, значение2, ...)
```

**Одна запись:**
```
INSERT INTO Contact (FirstName, LastName, Email)
VALUES ('Иван', 'Петров', 'ivan@example.com')
```

**Несколько записей (batch):**
```
INSERT INTO Contact (FirstName, LastName, Email)
VALUES
  ('Иван', 'Петров', 'ivan@example.com'),
  ('Мария', 'Сидорова', 'maria@example.com')
```

### 7.2. UPDATE

Обновление записей по условию.

```
UPDATE <объект> SET поле1 = значение1, поле2 = значение2 [WHERE условие]
```

**Примеры:**
```
UPDATE Contact SET Status = 'Active' WHERE Id = '550e8400-e29b-41d4-a716-446655440000'

UPDATE Account SET Revenue = 1000000, Industry = 'Tech'
WHERE Name LIKE 'Acme%'
```

> **Важно:** RLS автоматически ограничивает UPDATE только записями, видимыми текущему пользователю. Попытка обновить чужую запись не вызовет ошибку, но запись не будет затронута.

### 7.3. DELETE

Удаление записей по условию.

```
DELETE FROM <объект> WHERE условие
```

**Пример:**
```
DELETE FROM Task WHERE Status = 'Completed' AND CreatedAt < 2023-01-01
```

> **Важно:** По умолчанию `WHERE` обязателен для DELETE (защита от случайного удаления всех записей). RLS ограничивает удаление только видимыми записями.

### 7.4. UPSERT

Вставка или обновление на основе внешнего идентификатора.

```
UPSERT <объект> (поле1, поле2, ...) VALUES (значение1, значение2, ...) ON <внешний_ключ>
```

Если запись с указанным значением внешнего ключа существует — выполняется UPDATE. Если не существует — INSERT.

**Пример:**
```
UPSERT Account (Name, Revenue, ExternalId)
VALUES ('Acme Inc', 1000000, 'ext_001')
ON ExternalId
```

**Batch UPSERT:**
```
UPSERT Account (Name, Revenue, ExternalId)
VALUES
  ('Acme', 1000000, 'ext_001'),
  ('Globex', 500000, 'ext_002')
ON ExternalId
```

### 7.5. Функции в DML

В значениях INSERT, UPDATE и UPSERT можно использовать те же функции, что и в SOQL:

```
INSERT INTO Contact (FirstName, Email)
VALUES (UPPER('ivan'), COALESCE(NULL, 'default@example.com'))

UPDATE Contact SET Email = LOWER(Email) WHERE Status = 'Pending'
```

### 7.6. Безопасность в DML

| Операция | OLS | FLS | RLS |
|----------|-----|-----|-----|
| **INSERT** | CanCreate | CanWrite (каждое поле) | — (не нужен) |
| **UPDATE** | CanUpdate | CanWrite (каждое поле) | WHERE injection (только видимые записи) |
| **DELETE** | CanDelete | — | WHERE injection (только видимые записи) |
| **UPSERT** | CanCreate + CanUpdate | CanWrite (каждое поле) | — (INSERT path) |

Системные поля (`Id`, `CreatedAt`, `UpdatedAt`, `CreatedById`, `UpdatedById`) — только для чтения, их нельзя указывать в DML. Поле `OwnerId` — записываемое.

### 7.7. API

**POST** `/api/v1/data`

Тело запроса:
```json
{
  "statement": "INSERT INTO Contact (FirstName, LastName) VALUES ('Иван', 'Петров')"
}
```

Ответ:
```json
{
  "rows_affected": 1,
  "inserted_ids": ["550e8400-e29b-41d4-a716-446655440000"]
}
```

Для UPDATE/DELETE — `updated_ids` / `deleted_ids` соответственно.

### 7.8. Лимиты

| Параметр | Значение по умолчанию |
|----------|----------------------|
| Максимум строк в batch (INSERT/UPSERT) | 10 000 |
| Длина выражения | 100 000 символов |
| WHERE обязателен для DELETE | Да |

---

## 8. Управление территориями (Enterprise)

> **Внимание:** Управление территориями доступно только в Enterprise-редакции (лицензия Adverax Commercial License). В Community-редакции эти эндпоинты отсутствуют.

Территории — это механизм организации доступа к записям на основе географических, функциональных или иных критериев. Территории работают параллельно с иерархией ролей и расширяют модель RLS.

Базовый маршрут: `/api/v1/admin/territory`

### 8.1. Модели территорий

Модель территорий — контейнер верхнего уровня, определяющий набор территорий. Модель имеет жизненный цикл: `planning` → `active` → `archived`.

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/models` | Создать модель |
| GET | `/territory/models` | Список моделей (с пагинацией) |
| GET | `/territory/models/:id` | Получить модель по ID |
| PUT | `/territory/models/:id` | Обновить модель |
| DELETE | `/territory/models/:id` | Удалить модель |
| POST | `/territory/models/:id/activate` | Активировать модель |
| POST | `/territory/models/:id/archive` | Архивировать модель |

#### Создание модели

```json
{
  "api_name": "fy2026",
  "label": "Территориальная модель FY2026",
  "description": "Модель территорий на 2026 финансовый год"
}
```

#### Жизненный цикл

- **Planning** — начальное состояние. Можно редактировать структуру территорий.
- **Active** — модель активна, территории влияют на видимость записей.
- **Archived** — модель архивирована, территории не влияют на доступ.

Переходы: `planning → active` (активация), `active → archived` (архивация).

### 8.2. Территории

Территория — узел в иерархическом дереве внутри модели. Территории образуют дерево (parent → children).

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/territories` | Создать территорию |
| GET | `/territory/territories?model_id=<uuid>` | Список территорий модели |
| GET | `/territory/territories/:id` | Получить территорию по ID |
| PUT | `/territory/territories/:id` | Обновить территорию |
| DELETE | `/territory/territories/:id` | Удалить территорию |

#### Создание территории

```json
{
  "model_id": "...",
  "parent_id": null,
  "api_name": "moscow_region",
  "label": "Московский регион",
  "description": "Включает Москву и Московскую область"
}
```

При `parent_id = null` создаётся корневая территория. При указании `parent_id` — дочерняя.

### 8.3. Настройки объектов по умолчанию

Определяют, какой уровень доступа территория предоставляет к записям конкретного объекта.

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/territories/:id/object-defaults` | Установить настройку |
| GET | `/territory/territories/:id/object-defaults` | Список настроек территории |
| DELETE | `/territory/territories/:id/object-defaults/:objectId` | Удалить настройку |

#### Установка настройки

```json
{
  "object_id": "...",
  "access_level": "read_write"
}
```

Уровни доступа: `read`, `read_write`.

### 8.4. Назначение пользователей

Пользователи назначаются в территории (M:M связь). Пользователь может быть назначен в несколько территорий.

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/territories/:id/users` | Назначить пользователя |
| GET | `/territory/territories/:id/users` | Список пользователей территории |
| DELETE | `/territory/territories/:id/users/:userId` | Отозвать пользователя |

#### Назначение

```json
{
  "user_id": "..."
}
```

### 8.5. Назначение записей

Конкретные записи могут быть привязаны к территории.

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/territories/:id/records` | Привязать запись |
| GET | `/territory/territories/:id/records` | Список записей территории |
| DELETE | `/territory/territories/:id/records/:recordId?object_id=<uuid>` | Отвязать запись |

#### Привязка записи

```json
{
  "record_id": "...",
  "object_id": "...",
  "reason": "manual"
}
```

### 8.6. Правила назначения

Правила автоматически назначают записи в территории на основе критериев.

#### Маршруты

| Метод | Маршрут | Описание |
|-------|---------|----------|
| POST | `/territory/assignment-rules` | Создать правило |
| GET | `/territory/assignment-rules?territory_id=<uuid>` | Список правил территории |
| GET | `/territory/assignment-rules/:id` | Получить правило по ID |
| PUT | `/territory/assignment-rules/:id` | Обновить правило |
| DELETE | `/territory/assignment-rules/:id` | Удалить правило |

### Как территории влияют на RLS

Пользователь, назначенный в территорию, получает доступ к записям этой территории (и всех дочерних территорий) на уровне, определённом в object-defaults. Доступ предоставляется через share-таблицы объектов с причиной `territory`.

---

## 9. Типичные сценарии

### Сценарий 1: Первый вход в систему

1. Убедитесь, что при запуске сервера задана переменная окружения `ADMIN_INITIAL_PASSWORD`.
2. Перейдите на страницу входа (`/login`).
3. Введите:
   - Имя пользователя: `admin`
   - Пароль: значение из `ADMIN_INITIAL_PASSWORD`
4. Нажмите **«Войти»**.
5. После входа рекомендуется сменить пароль администратора через API:
   ```
   PUT /api/v1/admin/security/users/<admin-uuid>/password
   {"password": "новый-надёжный-пароль"}
   ```

### Сценарий 2: Восстановить забытый пароль

1. На странице входа (`/login`) нажмите **«Забыли пароль?»**.
2. Введите email, привязанный к учётной записи.
3. Нажмите **«Отправить»**.
4. Откройте письмо и перейдите по ссылке сброса пароля.
5. Введите новый пароль и подтвердите его.
6. Нажмите **«Сбросить пароль»**.
7. Войдите с новым паролем.

### Сценарий 3: Создать новый объект с полями

1. Перейдите в **Объекты** (`/admin/metadata/objects`).
2. Нажмите **«Создать объект»**.
3. Заполните:
   - API Name: `Invoice__c`
   - Название: `Счёт`
   - Мн. число: `Счета`
   - Тип объекта: `custom`
   - Включите нужные флаги (как минимум: Создание записей, Обновление записей, Запросы).
4. Нажмите **«Создать»**.
5. На детальной странице объекта перейдите на вкладку **«Поля»**.
6. Нажмите **«Добавить поле»** и создайте поля:
   - `number__c` — тип `text`, подтип `plain`, макс. длина: 50, обязательное, уникальное.
   - `amount__c` — тип `number`, подтип `currency`, точность: 18, масштаб: 2.
   - `invoice_date__c` — тип `datetime`, подтип `date`.
   - `account_id__c` — тип `reference`, подтип `association`, ссылочный объект: `Account`, при удалении: `set_null`.

### Сценарий 4: Настроить доступ к объекту

1. Создайте или откройте **набор разрешений** (`/admin/security/permission-sets`).
   - При создании: API Name: `invoice_access`, Название: «Доступ к счетам», Тип: `Grant`.
2. Перейдите на вкладку **«Права на объекты»**.
3. Найдите строку `Invoice__c` и отметьте нужные чекбоксы: Чтение, Создание, Обновление.
4. Перейдите на вкладку **«Права на поля»**.
5. Выберите объект `Invoice__c` в выпадающем списке.
6. Для каждого поля отметьте: Чтение и Запись.

### Сценарий 5: Создать пользователя с полным набором безопасности

1. **Создайте роль** (если ещё нет):
   - Перейдите в **Роли** → **«Создать роль»**.
   - API Name: `sales_manager`, Название: «Менеджер по продажам».
   - Родительская роль: выберите при необходимости.

2. **Создайте профиль** (если ещё нет):
   - Перейдите в **Профили** → **«Создать профиль»**.
   - API Name: `sales_profile`, Название: «Профиль продаж».

3. **Настройте OLS/FLS профиля:**
   - На детальной странице профиля нажмите ссылку **«Открыть базовый набор разрешений»**.
   - На вкладке **«Права на объекты»** — настройте CRUD-права.
   - На вкладке **«Права на поля»** — настройте доступ к полям.

4. **Создайте пользователя:**
   - Перейдите в **Пользователи** → **«Создать пользователя»**.
   - Заполните: username, email, имя, фамилия.
   - Выберите профиль: «Профиль продаж».
   - Выберите роль: «Менеджер по продажам».

5. **Назначьте дополнительные наборы разрешений** (при необходимости):
   - На детальной странице пользователя перейдите на вкладку **«Наборы разрешений»**.
   - Нажмите **«Назначить набор»** и выберите нужный.

### Сценарий 6: Ограничить доступ пользователю с помощью Deny

1. Создайте **deny-набор разрешений:**
   - Перейдите в **Наборы разрешений** → **«Создать набор»**.
   - API Name: `no_delete_invoices`, Название: «Запрет удаления счетов», Тип: `Deny`.
2. На вкладке **«Права на объекты»** — отметьте чекбокс **Удаление** для объекта `Invoice__c`.
3. Назначьте этот набор пользователю:
   - Откройте детальную страницу пользователя → вкладка **«Наборы разрешений»** → **«Назначить набор»** → выберите «Запрет удаления счетов».

Теперь, даже если профиль пользователя разрешает удаление счетов, deny-набор его заблокирует.

### Сценарий 7: Передать пользователю другую роль

1. Перейдите в **Пользователи** → откройте нужного пользователя.
2. На вкладке **«Основное»** измените значение в поле **Роль**.
3. Нажмите **«Сохранить»**.

Членство в ролевых группах пересчитается автоматически.

### Сценарий 8: Настроить видимость объекта

1. Перейдите в **Объекты** → откройте нужный объект.
2. В поле **«Видимость (OWD)»** выберите нужное значение:
   - `private` — записи видит только владелец (по умолчанию).
   - `public_read` — все могут читать, обновлять — только владелец.
   - `public_read_write` — полный доступ для всех (share-таблица не создаётся).
   - `controlled_by_parent` — доступ определяется родительским объектом.
3. Нажмите **«Сохранить»**.

> **Внимание:** При смене с `public_read_write` на любой другой режим создаётся share-таблица. При смене на `public_read_write` — share-таблица удаляется вместе со всеми записями шаринга.

### Сценарий 9: Расшарить записи отделу продаж

1. **Создайте правило совместного доступа:**
   - Объект: выберите нужный (например, `Invoice__c`).
   - Тип правила: `owner_based`.
   - Исходная группа: `role_sales_manager` (владельцы записей — менеджеры).
   - Целевая группа: `role_and_sub_sales_director` (доступ — директор и все подчинённые).
   - Уровень доступа: `read`.

Теперь все записи, принадлежащие менеджерам по продажам, будут видны директору по продажам и его подчинённым.

### Сценарий 10: Предоставить ручной доступ к конкретной записи

1. Вызовите API ручного шаринга:
   - Таблица: `obj_invoice` (имя таблицы объекта).
   - ID записи: UUID конкретного счёта.
   - Группа: UUID персональной группы пользователя (или публичной группы).
   - Уровень доступа: `read_write`.

Запись появится в share-таблице `obj_invoice__share` с причиной `manual`.

### Сценарий 11: Создать публичную группу для проектной команды

1. Создайте группу типа `public`:
   - API Name: `project_alpha_team`
   - Название: «Команда проекта Alpha»
2. Добавьте участников — по одному пользователю или целой группе.
3. Используйте эту группу в правилах совместного доступа или для ручного шаринга.

---

### Сценарий 12: Выполнить SOQL-запрос к данным

1. Отправьте GET-запрос:
   ```
   GET /api/v1/query?q=SELECT Id, Name, Email FROM Contact WHERE Status = 'Active' ORDER BY Name LIMIT 20
   ```
2. Или POST-запрос для длинных запросов:
   ```json
   POST /api/v1/query
   {
     "query": "SELECT Name, SUM(Amount) FROM Deal GROUP BY Name HAVING SUM(Amount) > 100000",
     "pageSize": 50
   }
   ```
3. Ответ содержит массив `records` с полями, запрошенными в SELECT. Все поля, недоступные пользователю по FLS, будут исключены. Записи, невидимые по RLS, не попадут в результат.

### Сценарий 13: Создать записи через DML

1. Отправьте POST-запрос:
   ```json
   POST /api/v1/data
   {
     "statement": "INSERT INTO Contact (FirstName, LastName, Email) VALUES ('Иван', 'Петров', 'ivan@example.com')"
   }
   ```
2. Ответ содержит `inserted_ids` — список UUID созданных записей.
3. Для пакетной вставки передайте несколько строк VALUES через запятую (до 10 000 строк).

### Сценарий 14: Обновить записи через DML

1. Отправьте POST-запрос:
   ```json
   POST /api/v1/data
   {
     "statement": "UPDATE Contact SET Status = 'Inactive' WHERE LastLoginDate < 2025-01-01"
   }
   ```
2. Ответ содержит `updated_ids`. RLS гарантирует, что обновятся только записи, видимые текущему пользователю.

### Сценарий 15: Настроить территориальную модель (Enterprise)

1. **Создайте модель:** POST `/api/v1/admin/territory/models` с `api_name`, `label`.
2. **Создайте территории:** POST `/api/v1/admin/territory/territories` — корневую и дочерние (указывая `parent_id`).
3. **Настройте доступ:** POST `/api/v1/admin/territory/territories/:id/object-defaults` — укажите `object_id` и `access_level` (`read` или `read_write`) для каждого объекта.
4. **Назначьте пользователей:** POST `/api/v1/admin/territory/territories/:id/users` — добавьте пользователей в территории.
5. **Активируйте модель:** POST `/api/v1/admin/territory/models/:id/activate` — территории начнут влиять на видимость записей.

---

*Документ создан для CRM Platform. Актуален для Phase 0–5 (Scaffolding, Metadata engine, Security engine, SOQL, DML, Auth) + Territory Management (Enterprise).*
