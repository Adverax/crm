# ADR-0002: Стратегия интернационализации

**Статус:** Принято
**Дата:** 2026-02-08
**Участники:** @roman_myakotin

## Контекст

CRM-платформа ориентирована на enterprise-сегмент, где пользователи могут работать
на разных языках. Интернационализация затрагивает два вида контента:

- **Динамический** — метаданные объектов, полей, picklist-значения, validation rules.
  Создаётся администратором в runtime, хранится в БД, количество растёт.
- **Статический** — кнопки, меню, системные ошибки, шаблоны уведомлений.
  Создаётся разработчиком, деплоится с кодом, количество фиксировано.

Нужен единый подход к i18n, который при этом учитывает разную природу контента.

## Рассмотренные варианты

### Вариант A: i18n-ключи везде

Все строки (и в БД, и в UI) заменяются на ключи (`object.contact.label`),
которые резолвятся через единый словарь.

**Плюсы:**
- Полная унификация

**Минусы:**
- Без словаря пользователь видит ключи вместо текста
- Усложняет админский UI — создание custom-объекта требует заполнения словаря
- UI-строки в БД — лишние запросы на каждый рендер для данных, не меняющихся между деплоями
- Жизненные циклы динамического и статического контента принципиально различны

### Вариант B: Прямые строки без i18n

Все labels хранятся как обычные строки на одном языке.

**Плюсы:**
- Максимальная простота

**Минусы:**
- Невозможна мультиязычность
- Непригодно для enterprise с международными командами

### Вариант C: Default value + translation overlay (выбран)

Единый паттерн для всей платформы, но с двумя механизмами хранения:

1. **Динамический контент** — default-значение inline в записи БД + полиморфная таблица `translations`
2. **Статический контент** — JSON-файлы локалей (vue-i18n на фронте, embedded-файлы в Go-бинаре)

**Плюсы:**
- Работает из коробки на default-языке — переводы опциональны
- Fallback-цепочка: перевод → default → ключ — пользователь никогда не видит пустоту
- Один паттерн, понятный и разработчикам, и администраторам
- Динамический контент не тормозит UI-рендер
- Статический контент версионируется в git

**Минусы:**
- Два механизма хранения (БД + файлы), хотя концептуальный паттерн един

## Решение

Принимаем **Вариант C** — единый паттерн «default value + optional translation», два хранилища.

### Динамический контент — таблица `translations`

```sql
CREATE TABLE translations (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    resource_type   VARCHAR(100) NOT NULL,  -- 'ObjectDef', 'FieldDef', 'PicklistValue', ...
    resource_id     UUID         NOT NULL,  -- ID ресурса
    field_name      VARCHAR(100) NOT NULL,  -- 'label', 'plural_label', 'description', 'help_text'
    locale          VARCHAR(10)  NOT NULL,  -- 'en', 'ru', 'de', ...
    value           TEXT         NOT NULL,
    created_at      TIMESTAMPTZ  NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ  NOT NULL DEFAULT now(),
    UNIQUE (resource_type, resource_id, field_name, locale)
);
```

Покрывает:
- Метаданные объектов (`label`, `plural_label`, `description`)
- Метаданные полей (`label`, `help_text`, `description`)
- Значения picklist-ов
- Сообщения validation rules
- Названия layout-ов и страниц

### Статический контент — файлы локалей

```
web/src/locales/ru.json   ← default-язык
web/src/locales/en.json   ← перевод
internal/locales/ru.json  ← серверные сообщения (ошибки, уведомления)
internal/locales/en.json
```

### Единый паттерн resolve

```
1. Определить locale из контекста пользователя
2. Искать перевод для locale
3. Если нет — fallback на default value
4. Если нет — вернуть ключ (только для статического контента)
```

### Locale пользователя

Хранится в профиле пользователя (`users.locale`). Передаётся в контексте каждого запроса.

## Последствия

- Поля `label`, `plural_label`, `description`, `help_text` в таблицах метаданных хранят default-значение напрямую
- Таблица `translations` создаётся при необходимости (не обязательна для MVP)
- Frontend использует vue-i18n с JSON-файлами
- Backend для системных сообщений использует embedded JSON-файлы
- API метаданных возвращает resolved-значения с учётом locale из запроса
