# ADR-0001: UUID как идентификатор записей

**Статус:** Принято
**Дата:** 2026-02-08
**Участники:** @roman_myakotin

## Контекст

Платформа CRM с metadata-driven архитектурой требует единого формата идентификаторов записей.
Необходимо выбрать формат, который обеспечит:
- Уникальность в рамках всей системы
- Непредсказуемость (защита от IDOR-атак)
- Производительность при индексации и join-операциях
- Поддержку полиморфных ссылок (запись может ссылаться на объекты разных типов)

## Рассмотренные варианты

### Вариант A: Составной ID с key_prefix (как в Salesforce)

Формат: `{3 символа prefix}{16 символов random}`, например `001a1B2c3D4e5F6g7`.

Префикс кодирует тип объекта — по ID можно определить, что `001...` это Account.

**Плюсы:**
- Полиморфная ссылка одним полем — тип объекта закодирован в самом ID
- Удобство отладки — тип виден сразу
- URL-роутинг без указания типа: `/record/001xxxx`

**Минусы:**
- Строковый PK (19 символов) — деградация индексов и join-ов по сравнению с нативным UUID (16 байт)
- FK constraints невозможны для полиморфных ссылок — валидация только в коде
- Нужен реестр префиксов, генератор уникальных ID, обработка коллизий
- Исторический паттерн Salesforce (1999), не обусловленный современными реалиями

### Вариант B: UUID v4 (выбран)

Нативный PostgreSQL тип `uuid`. Для полиморфных ссылок используется явная пара полей.

**Плюсы:**
- Нативная поддержка PostgreSQL: тип `uuid` = 16 байт, оптимизированный B-tree
- Непредсказуемость из коробки — защита от перебора
- FK constraints работают для прямых (не-полиморфных) ссылок
- Нет дополнительной инфраструктуры — стандартный `gen_random_uuid()`
- Совместимость с экосистемой (ORM, клиенты, инструменты)

**Минусы:**
- Полиморфная ссылка требует двух полей вместо одного

## Решение

Используем **UUID v4** как первичный ключ всех записей.

Для полиморфных ссылок (Activities, Notes, Feed) — явная пара полей:

```sql
related_object_type  VARCHAR(100) NOT NULL  -- API-имя объекта: 'Account', 'Contact'
related_record_id    UUID         NOT NULL  -- UUID записи
```

Составной индекс `(related_object_type, related_record_id)` обеспечивает быстрый поиск.

## Последствия

- Все таблицы используют `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- Системные поля `owner_id`, `created_by`, `updated_by` — тип `UUID` с FK на `users.id`
- Полиморфные таблицы (activities, notes, attachments, feed) содержат пару `(object_type, record_id)`
- SOQL-движок при резолве полиморфных полей выполняет lookup по `object_type`
